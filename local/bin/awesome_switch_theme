#!/usr/bin/env bash

# awesome_switch_theme
#
# Description: change theme of AwesomeWM
# Author: demingongo
# Link: https://github.com/demingongo
# Availability: https://github.com/demingongo/awesomewm-dotfiles

ALL_THEMES=()

THEMES_FILE="$HOME/.config/awesome/themes/themes.txt" 

while read -r line
do
	[[ -z "$line" ]] && break || ALL_THEMES=(${ALL_THEMES[@]} "$line")
done < "$THEMES_FILE"

is_interactive=false

if [ $# -eq 0 ]; then
	is_interactive=true
	gum style \
		--foreground 212 --border-foreground 212 --border double \
		--align center --width 50 --margin "1 2" --padding "2 4" \
		'AWESOME WM DOTFILES' 'by demingongo'

	echo "Select a theme:"
	
	choices=""
	for i in ${!ALL_THEMES[@]}; do
  		if [ $i -eq 0 ]; then
			choices="${ALL_THEMES[$i]}"
		else
			choices="""$choices
${ALL_THEMES[$i]}"""
  		fi
	done

	theme=$(echo "$choices" | gum choose --item.faint)

else
	[[ " ${ALL_THEMES[*]} " =~ " $1 " ]] && theme=$1 || exit 1	
fi

# Handle config files
Load_config()
{
	source_file=$1
	dest_file=$2
	default_content=$3
	default_content_file=$4

	# remove old backup file (to avoid overwriting symbolic link)
	rm -f "$dest_file~"


	if [ -f "$source_file" ]; then
		ln -s -b "$source_file" "$dest_file"		
	else
		if [ -f "$dest_file" ]; then
			cp "$dest_file" "$dest_file~"
		fi
		rm -f "$dest_file"
		if [ -f "$default_content_file" ]; then
			ln -s -b "$default_content_file" "$dest_file"
		else
			echo "$default_content" > "$dest_file"
		fi
	fi
}

if [[ -n "$theme" ]]; then
	[ "$is_interactive" = true ] && gum spin --spinner line --title "$theme" -- sleep 1

	# load theme
	echo "$theme" > "$HOME/.config/awesome/theme.txt"
	
	# load config
	CONFIG_DIR="$HOME/.config/awesome/config"
	mkdir -p "$CONFIG_DIR"

	# load zsh config
	ZSH_CONF=(
    		# source
		"$HOME/.config/awesome/themes/$theme/config/zshrc.conf"
		# destination
		"$CONFIG_DIR/zshrc.conf"
		# default content
		"# User configuration"
		# default content file
		"$CONFIG_DIR/zshrc.default.conf"
	)
	Load_config "${ZSH_CONF[0]}" "${ZSH_CONF[1]}" "${ZSH_CONF[2]}" "${ZSH_CONF[3]}"
	
	# load nvim config
	NVIM_CONF=(
		# source
		"$HOME/.config/awesome/themes/$theme/config/nvim-theme.vim"
		# destination
		"$CONFIG_DIR/nvim-theme.vim"
		# default content
		"\"\"\" Load theme"
		# default content file
		"$CONFIG_DIR/nvim-theme.default.vim"
	)
	Load_config "${NVIM_CONF[0]}" "${NVIM_CONF[1]}" "${NVIM_CONF[2]}" "${NVIM_CONF[3]}"

	# restart wm
	awesome-client 'awesome.restart()' > /dev/null 2>&1 &
	[ "$is_interactive" = true ] && echo "  $theme"
fi

